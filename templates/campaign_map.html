{% extends "base.html" %}

{% block title %}Campaign Map - Business Tycoon RPG{% endblock %}

{% block body_class %}world-{{ stats.world|lower }}{% endblock %}

{% block content %}
<div class="campaign-container">
    <div class="map-header">
        <h1 class="map-title">
            <i class="bi bi-map-fill"></i> CAMPAIGN
        </h1>
        <div class="map-nav">
            <a href="{{ url_for('hub') }}" class="map-btn">
                <i class="bi bi-house-door-fill"></i>
            </a>
            <a href="{{ url_for('boss_challenges') }}" class="map-btn map-btn-boss">
                <i class="bi bi-skull"></i>
            </a>
        </div>
    </div>
    
    <div class="discipline-tabs">
        {% for discipline, data in campaign.items() %}
        <button class="discipline-tab {% if loop.first %}active{% endif %}" data-discipline="{{ discipline }}">
            {% if discipline == 'Marketing' %}
            <i class="bi bi-megaphone-fill"></i>
            {% elif discipline == 'Finance' %}
            <i class="bi bi-currency-dollar"></i>
            {% elif discipline == 'Operations' %}
            <i class="bi bi-gear-fill"></i>
            {% elif discipline == 'Human Resources' %}
            <i class="bi bi-people-fill"></i>
            {% elif discipline == 'Legal' %}
            <i class="bi bi-briefcase-fill"></i>
            {% elif discipline == 'Strategy' %}
            <i class="bi bi-lightbulb-fill"></i>
            {% endif %}
            <span class="tab-name">{{ discipline.split()[0] }}</span>
            <span class="tab-stars"><i class="bi bi-star-fill"></i>{{ data.total_stars }}</span>
        </button>
        {% endfor %}
    </div>
    
    {% for discipline, data in campaign.items() %}
    <div class="visual-map {% if loop.first %}active{% endif %}" id="map-{{ discipline|replace(' ', '-') }}">
        <div class="map-background">
            <div class="map-overlay"></div>
        </div>
        
        <div class="map-stats">
            <div class="stat-pill">
                <i class="bi bi-star-fill text-warning"></i>
                {{ data.total_stars }}/{{ data.max_stars }}
            </div>
            <div class="stat-pill">
                <i class="bi bi-check-circle-fill text-success"></i>
                {{ data.completed_count }}/{{ data.total_count }}
            </div>
        </div>
        
        <svg class="path-svg" viewBox="0 0 360 600" preserveAspectRatio="xMidYMid meet">
            <defs>
                <linearGradient id="pathGradient-{{ discipline|replace(' ', '') }}" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ff8c00;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="lockedGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#444;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#222;stop-opacity:1" />
                </linearGradient>
                <filter id="glow">
                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
                <filter id="strongGlow">
                    <feGaussianBlur stdDeviation="6" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
            </defs>
            
            {% set positions = [
                {'x': 80, 'y': 550},
                {'x': 180, 'y': 510},
                {'x': 280, 'y': 470},
                {'x': 280, 'y': 390},
                {'x': 180, 'y': 350},
                {'x': 80, 'y': 310},
                {'x': 80, 'y': 230},
                {'x': 180, 'y': 190},
                {'x': 280, 'y': 150},
                {'x': 180, 'y': 80}
            ] %}
            
            {% for i in range(data.nodes|length - 1) %}
            {% set node = data.nodes[i] %}
            {% set next_node = data.nodes[i + 1] %}
            {% set pos = positions[i] %}
            {% set next_pos = positions[i + 1] %}
            <path class="node-path {% if node.completed %}path-complete{% elif node.unlocked %}path-active{% else %}path-locked{% endif %}"
                  d="M {{ pos.x }} {{ pos.y }} Q {{ (pos.x + next_pos.x) / 2 }} {{ (pos.y + next_pos.y) / 2 - 15 }} {{ next_pos.x }} {{ next_pos.y }}"
                  stroke="{% if node.completed %}url(#pathGradient-{{ discipline|replace(' ', '') }}){% elif node.unlocked %}#4a90d9{% else %}#333{% endif %}"
                  stroke-width="8"
                  stroke-linecap="round"
                  fill="none"
                  {% if node.completed %}filter="url(#glow)"{% endif %}/>
            {% endfor %}
            
            {% for node in data.nodes %}
            {% set pos = positions[loop.index0] %}
            <g class="map-node" data-scenario-id="{{ node.scenario_id }}" data-unlocked="{{ node.unlocked|lower }}">
                {% if node.completed %}
                <circle cx="{{ pos.x }}" cy="{{ pos.y }}" r="32" fill="#1a5c34" stroke="#50c878" stroke-width="4" filter="url(#glow)"/>
                <circle cx="{{ pos.x }}" cy="{{ pos.y }}" r="26" fill="url(#pathGradient-{{ discipline|replace(' ', '') }})" opacity="0.3"/>
                <text x="{{ pos.x }}" y="{{ pos.y + 5 }}" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">âœ“</text>
                <g class="node-stars" transform="translate({{ pos.x - 20 }}, {{ pos.y + 38 }})">
                    {% for i in range(3) %}
                    <text x="{{ i * 14 }}" y="0" fill="{% if i < node.stars %}#ffd700{% else %}#555{% endif %}" font-size="12">â˜…</text>
                    {% endfor %}
                </g>
                {% elif node.current %}
                <circle class="pulse-ring" cx="{{ pos.x }}" cy="{{ pos.y }}" r="40" fill="none" stroke="#ffd700" stroke-width="3" opacity="0.5"/>
                <circle cx="{{ pos.x }}" cy="{{ pos.y }}" r="32" fill="#b8860b" stroke="#ffd700" stroke-width="5" filter="url(#strongGlow)"/>
                <text x="{{ pos.x }}" y="{{ pos.y + 7 }}" text-anchor="middle" fill="#fff" font-size="20" font-weight="bold">{{ node.node_index }}</text>
                <text x="{{ pos.x }}" y="{{ pos.y + 55 }}" text-anchor="middle" fill="#ffd700" font-size="11" font-weight="bold">â–¶ PLAY</text>
                {% elif node.unlocked %}
                <circle cx="{{ pos.x }}" cy="{{ pos.y }}" r="30" fill="#1a3a5c" stroke="#4a90d9" stroke-width="4"/>
                <text x="{{ pos.x }}" y="{{ pos.y + 7 }}" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">{{ node.node_index }}</text>
                {% else %}
                <circle cx="{{ pos.x }}" cy="{{ pos.y }}" r="28" fill="url(#lockedGradient)" stroke="#444" stroke-width="3"/>
                <text x="{{ pos.x }}" y="{{ pos.y + 5 }}" text-anchor="middle" fill="#666" font-size="16">ðŸ”’</text>
                {% endif %}
                
                {% if node.level == 5 %}
                <text x="{{ pos.x + 35 }}" y="{{ pos.y - 20 }}" fill="#ff6b6b" font-size="10" font-weight="bold">ELITE</text>
                {% elif node.level == 10 %}
                <text x="{{ pos.x + 35 }}" y="{{ pos.y - 20 }}" fill="#dc143c" font-size="10" font-weight="bold">BOSS</text>
                {% endif %}
            </g>
            {% endfor %}
            
            <text x="180" y="30" text-anchor="middle" fill="#ffd700" font-size="14" font-weight="bold" opacity="0.8">
                {{ discipline|upper }}
            </text>
        </svg>
    </div>
    {% endfor %}
</div>

<style>
.campaign-container {
    position: relative;
    min-height: 100vh;
    padding: 0;
    margin: -1rem;
    overflow: hidden;
}

.map-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: rgba(0,0,0,0.8);
    border-bottom: 2px solid rgba(255,215,0,0.4);
    position: sticky;
    top: 0;
    z-index: 100;
}

.map-title {
    font-family: 'Cinzel', serif;
    font-size: 1.3rem;
    color: #ffd700;
    margin: 0;
    text-shadow: 0 0 10px rgba(255,215,0,0.5);
}

.map-nav {
    display: flex;
    gap: 10px;
}

.map-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, #2a2a4a, #1a1a2a);
    border: 2px solid rgba(255,215,0,0.5);
    color: #ffd700;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    text-decoration: none;
    transition: all 0.2s;
}

.map-btn:active {
    transform: scale(0.95);
    background: linear-gradient(135deg, #3a3a5a, #2a2a3a);
}

.map-btn-boss {
    border-color: rgba(220,20,60,0.7);
    color: #dc143c;
}

.discipline-tabs {
    display: flex;
    overflow-x: auto;
    background: rgba(0,0,0,0.9);
    padding: 8px 5px;
    gap: 5px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}

.discipline-tabs::-webkit-scrollbar {
    display: none;
}

.discipline-tab {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 12px;
    background: rgba(40,40,60,0.8);
    border: 2px solid transparent;
    border-radius: 10px;
    color: #888;
    font-size: 0.75rem;
    min-width: 60px;
    cursor: pointer;
    transition: all 0.2s;
}

.discipline-tab i {
    font-size: 1.2rem;
    margin-bottom: 3px;
}

.discipline-tab.active {
    background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(184,134,11,0.2));
    border-color: #ffd700;
    color: #ffd700;
}

.tab-name {
    font-weight: bold;
    white-space: nowrap;
}

.tab-stars {
    font-size: 0.65rem;
    color: #ffd700;
}

.tab-stars i {
    font-size: 0.6rem;
    margin-right: 2px;
}

.visual-map {
    display: none;
    position: relative;
    height: calc(100vh - 140px);
    overflow: hidden;
}

.visual-map.active {
    display: block;
}

.map-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(ellipse at top, rgba(30,30,60,0.3) 0%, rgba(10,10,30,0.9) 100%),
        linear-gradient(180deg, #0a0a1a 0%, #1a1a3a 50%, #0a0a2a 100%);
    z-index: 0;
}

.map-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,0.15), transparent),
        radial-gradient(2px 2px at 70% 20%, rgba(255,215,0,0.1), transparent),
        radial-gradient(1px 1px at 40% 70%, rgba(255,255,255,0.1), transparent),
        radial-gradient(2px 2px at 80% 60%, rgba(255,255,255,0.08), transparent);
    background-size: 200px 200px;
    animation: twinkle 4s ease-in-out infinite alternate;
}

.map-stats {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 8px;
    z-index: 10;
}

.stat-pill {
    background: rgba(0,0,0,0.7);
    border: 1px solid rgba(255,215,0,0.3);
    border-radius: 15px;
    padding: 5px 10px;
    font-size: 0.75rem;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 4px;
}

.path-svg {
    width: 100%;
    height: 100%;
    position: relative;
    z-index: 5;
}

.map-node {
    cursor: pointer;
    transition: transform 0.2s;
}

.map-node[data-unlocked="true"]:active {
    transform: scale(0.95);
}

.pulse-ring {
    animation: pulseRing 1.5s ease-out infinite;
}

@keyframes pulseRing {
    0% { r: 32; opacity: 0.8; }
    100% { r: 50; opacity: 0; }
}

@keyframes twinkle {
    0% { opacity: 0.5; }
    100% { opacity: 1; }
}

.path-complete {
    stroke-dasharray: none;
}

.path-active {
    stroke-dasharray: 10 5;
    animation: dashMove 1s linear infinite;
}

@keyframes dashMove {
    to { stroke-dashoffset: -15; }
}

.path-locked {
    stroke-dasharray: 5 10;
}

@media (min-width: 500px) {
    .path-svg {
        max-width: 400px;
        margin: 0 auto;
        display: block;
    }
}

@media (max-height: 600px) {
    .visual-map {
        height: calc(100vh - 120px);
    }
    
    .path-svg {
        height: auto;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.discipline-tab');
    const maps = document.querySelectorAll('.visual-map');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            maps.forEach(m => m.classList.remove('active'));
            
            this.classList.add('active');
            const discipline = this.dataset.discipline.replace(/ /g, '-');
            const mapElement = document.getElementById('map-' + discipline);
            if (mapElement) {
                mapElement.classList.add('active');
            }
        });
    });
    
    document.querySelectorAll('.map-node').forEach(node => {
        const unlocked = node.dataset.unlocked === 'true';
        const scenarioId = node.dataset.scenarioId;
        
        if (unlocked && scenarioId) {
            node.style.cursor = 'pointer';
            node.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = '/play/' + scenarioId;
            });
            node.addEventListener('touchend', function(e) {
                e.preventDefault();
                window.location.href = '/play/' + scenarioId;
            });
        }
    });
});
</script>
{% endblock %}
