{% extends "core/base.html" %}

{% block title %}{{ path.path_name }} - Learning Path{% endblock %}

{% block content %}
<style>
    .detail-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 1rem;
    }
    .detail-header {
        background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(0, 0, 0, 0.8));
        border: 2px solid rgba(76, 175, 80, 0.4);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
    }
    .detail-header h1 {
        color: #81c784;
        font-family: 'Cinzel', serif;
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
    }
    .detail-header p {
        color: #d0d0d0;
        font-size: 1rem;
        max-width: 600px;
        margin: 0 auto;
    }
    .path-progress {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    .progress-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: conic-gradient(#4caf50 var(--progress), rgba(255,255,255,0.1) var(--progress));
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .progress-inner {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #81c784;
        font-weight: 700;
        font-size: 1.1rem;
    }
    .stage-card {
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 1.25rem;
        transition: all 0.3s ease;
    }
    .stage-card.completed {
        border-color: rgba(76, 175, 80, 0.5);
        background: rgba(76, 175, 80, 0.1);
    }
    .stage-card.current {
        border-color: rgba(33, 150, 243, 0.6);
        background: rgba(33, 150, 243, 0.1);
    }
    .stage-card.locked {
        opacity: 0.6;
    }
    .stage-number {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        font-weight: 700;
        flex-shrink: 0;
    }
    .stage-number.completed {
        background: linear-gradient(135deg, #4caf50, #388e3c);
        color: white;
    }
    .stage-number.current {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
    }
    .stage-number.locked {
        background: rgba(255, 255, 255, 0.1);
        color: #666;
    }
    .stage-content {
        flex: 1;
    }
    .stage-title {
        color: #ffffff;
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    .stage-subtitle {
        color: #b0b0b0;
        font-size: 0.9rem;
    }
    .stage-status {
        font-size: 0.85rem;
        padding: 0.35rem 0.75rem;
        border-radius: 15px;
    }
    .stage-status.completed {
        background: rgba(76, 175, 80, 0.2);
        color: #81c784;
    }
    .stage-status.current {
        background: rgba(33, 150, 243, 0.2);
        color: #64b5f6;
    }
    .stage-status.locked {
        background: rgba(255, 255, 255, 0.1);
        color: #888;
    }
    .btn-stage {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    .btn-stage.start {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
    }
    .btn-stage.start:hover {
        background: linear-gradient(135deg, #42a5f5, #1e88e5);
        color: white;
    }
    .btn-stage.review {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid rgba(76, 175, 80, 0.4);
        color: #81c784;
    }
    .completion-banner {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 152, 0, 0.2));
        border: 2px solid rgba(255, 215, 0, 0.5);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        margin-top: 2rem;
    }
    .completion-banner h3 {
        color: #ffd700;
        font-family: 'Cinzel', serif;
        margin-bottom: 1rem;
    }
    .completion-rewards {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 1.5rem;
    }
    .completion-reward {
        font-size: 1.25rem;
    }
    .completion-reward.gold { color: #ffd700; }
    .completion-reward.exp { color: #64b5f6; }
    .btn-claim {
        background: linear-gradient(135deg, #ffd700, #ff9800);
        color: #1a1a2e;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 25px;
        font-weight: 700;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .btn-claim:hover {
        transform: scale(1.05);
    }
    .btn-claim:disabled {
        background: #666;
        color: #999;
        cursor: not-allowed;
    }
</style>

<div class="detail-container">
    <div class="detail-header">
        <a href="{{ url_for('finance.learning_paths_list') }}" class="btn btn-sm btn-outline-light mb-3">
            <i class="bi bi-arrow-left"></i> All Paths
        </a>
        <h1>
            {% if path.path_completed %}<i class="bi bi-trophy-fill text-warning"></i>{% endif %}
            {{ path.path_name }}
        </h1>
        <p>{{ path.path_description }}</p>
        
        {% set stages_done = (1 if path.lesson_completed else 0) + (1 if path.trial_completed else 0) + (1 if path.puzzle_completed else 0) + (1 if path.scenario_completed else 0) %}
        {% set total_stages = (1 if path.lesson_module_id else 0) + (1 if path.trial_id else 0) + (1 if path.puzzle_id else 0) + (1 if path.scenario_id else 0) %}
        {% set progress_pct = (stages_done / total_stages * 100) if total_stages > 0 else 0 %}
        
        <div class="path-progress">
            <div class="progress-circle" style="--progress: {{ progress_pct }}%;">
                <div class="progress-inner">{{ progress_pct|int }}%</div>
            </div>
            <div style="text-align: left;">
                <div style="color: #81c784; font-weight: 600;">{{ stages_done }}/{{ total_stages }} Complete</div>
                <div style="color: #888; font-size: 0.9rem;">{{ path.discipline }} Path</div>
            </div>
        </div>
    </div>
    
    {% set stage_num = 1 %}
    
    {% if path.lesson_module_id %}
    <div class="stage-card {% if path.lesson_completed %}completed{% elif stage_num == 1 %}current{% else %}locked{% endif %}">
        <div class="stage-number {% if path.lesson_completed %}completed{% elif stage_num == 1 %}current{% else %}locked{% endif %}">
            {% if path.lesson_completed %}<i class="bi bi-check-lg"></i>{% else %}{{ stage_num }}{% endif %}
        </div>
        <div class="stage-content">
            <div class="stage-title"><i class="bi bi-book"></i> {{ path.lesson_title or 'Lesson' }}</div>
            <div class="stage-subtitle">Learn the key concepts and theory</div>
        </div>
        {% if path.lesson_completed %}
        <span class="stage-status completed"><i class="bi bi-check-circle"></i> Complete</span>
        <a href="{{ url_for('social.mentorship_lesson', module_id=path.lesson_module_id, path_id=path.path_id) }}" class="btn-stage review">Review</a>
        {% else %}
        <a href="{{ url_for('social.mentorship_lesson', module_id=path.lesson_module_id, path_id=path.path_id) }}" class="btn-stage start">Start Lesson</a>
        {% endif %}
    </div>
    {% set stage_num = stage_num + 1 %}
    {% endif %}
    
    {% if path.trial_id %}
    {% set can_start_trial = path.lesson_completed or not path.lesson_module_id %}
    <div class="stage-card {% if path.trial_completed %}completed{% elif can_start_trial and not path.trial_completed %}current{% else %}locked{% endif %}">
        <div class="stage-number {% if path.trial_completed %}completed{% elif can_start_trial %}current{% else %}locked{% endif %}">
            {% if path.trial_completed %}<i class="bi bi-check-lg"></i>{% else %}{{ stage_num }}{% endif %}
        </div>
        <div class="stage-content">
            <div class="stage-title"><i class="bi bi-question-circle"></i> {{ path.trial_name or 'Knowledge Quiz' }}</div>
            <div class="stage-subtitle">Test your understanding with {{ path.mentor_name or 'a mentor' }}</div>
        </div>
        {% if path.trial_completed %}
        <span class="stage-status completed"><i class="bi bi-check-circle"></i> Score: {{ path.trial_score or 0 }}%</span>
        <a href="{{ url_for('finance.mentor_trial', trial_id=path.trial_id, path_id=path.path_id) }}" class="btn-stage review">Retry</a>
        {% elif can_start_trial %}
        <a href="{{ url_for('finance.mentor_trial', trial_id=path.trial_id, path_id=path.path_id) }}" class="btn-stage start">Take Quiz</a>
        {% else %}
        <span class="stage-status locked"><i class="bi bi-lock"></i> Complete lesson first</span>
        {% endif %}
    </div>
    {% set stage_num = stage_num + 1 %}
    {% endif %}
    
    {% if path.puzzle_id %}
    {% set can_start_puzzle = path.trial_completed or not path.trial_id %}
    <div class="stage-card {% if path.puzzle_completed %}completed{% elif can_start_puzzle and not path.puzzle_completed %}current{% else %}locked{% endif %}">
        <div class="stage-number {% if path.puzzle_completed %}completed{% elif can_start_puzzle %}current{% else %}locked{% endif %}">
            {% if path.puzzle_completed %}<i class="bi bi-check-lg"></i>{% else %}{{ stage_num }}{% endif %}
        </div>
        <div class="stage-content">
            <div class="stage-title"><i class="bi bi-calculator"></i> {{ path.puzzle_name or 'Calculation Challenge' }}</div>
            <div class="stage-subtitle">Apply formulas with {{ path.merchant_name or 'a merchant' }}</div>
        </div>
        {% if path.puzzle_completed %}
        <span class="stage-status completed"><i class="bi bi-check-circle"></i> Solved in {{ path.puzzle_time_seconds or 0 }}s</span>
        <a href="{{ url_for('finance.merchant_puzzle', puzzle_id=path.puzzle_id, path_id=path.path_id) }}" class="btn-stage review">Retry</a>
        {% elif can_start_puzzle %}
        <a href="{{ url_for('finance.merchant_puzzle', puzzle_id=path.puzzle_id, path_id=path.path_id) }}" class="btn-stage start">Solve Puzzle</a>
        {% else %}
        <span class="stage-status locked"><i class="bi bi-lock"></i> Complete quiz first</span>
        {% endif %}
    </div>
    {% set stage_num = stage_num + 1 %}
    {% endif %}
    
    {% if path.scenario_id %}
    {% set can_start_scenario = path.puzzle_completed or not path.puzzle_id %}
    <div class="stage-card {% if path.scenario_completed %}completed{% elif can_start_scenario and not path.scenario_completed %}current{% else %}locked{% endif %}">
        <div class="stage-number {% if path.scenario_completed %}completed{% elif can_start_scenario %}current{% else %}locked{% endif %}">
            {% if path.scenario_completed %}<i class="bi bi-check-lg"></i>{% else %}{{ stage_num }}{% endif %}
        </div>
        <div class="stage-content">
            <div class="stage-title"><i class="bi bi-flag"></i> {{ path.scenario_title or 'Business Scenario' }}</div>
            <div class="stage-subtitle">Apply your knowledge in a real situation</div>
        </div>
        {% if path.scenario_completed %}
        <span class="stage-status completed"><i class="bi bi-star-fill"></i> {{ path.scenario_stars or 0 }} Stars</span>
        {% elif can_start_scenario %}
        <a href="{{ url_for('scenarios.training', scenario_id=path.scenario_id) }}" class="btn-stage start">Play Scenario</a>
        {% else %}
        <span class="stage-status locked"><i class="bi bi-lock"></i> Complete challenge first</span>
        {% endif %}
    </div>
    {% endif %}
    
    {% if path.path_completed %}
    <div class="completion-banner">
        <h3><i class="bi bi-trophy-fill"></i> Path Complete!</h3>
        <div class="completion-rewards">
            <span class="completion-reward gold"><i class="bi bi-coin"></i> +{{ path.gold_bonus }} Gold</span>
            <span class="completion-reward exp"><i class="bi bi-lightning-charge"></i> +{{ path.exp_bonus }} XP</span>
        </div>
        {% if path.bonus_claimed %}
        <button class="btn-claim" disabled><i class="bi bi-check-circle"></i> Rewards Claimed</button>
        {% else %}
        <form action="{{ url_for('finance.claim_path_bonus', path_id=path.path_id) }}" method="POST" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn-claim"><i class="bi bi-gift"></i> Claim Rewards</button>
        </form>
        {% endif %}
    </div>
    {% endif %}
    
    <div class="text-center mt-4">
        <a href="{{ url_for('finance.learning_paths_list') }}" class="btn btn-outline-light">
            <i class="bi bi-arrow-left"></i> All Learning Paths
        </a>
    </div>
</div>
{% endblock %}
