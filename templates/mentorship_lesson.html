{% extends "base.html" %}

{% block title %}{{ module.module_title }} - Mentorship{% endblock %}

{% block content %}
<style>
    .mentor-container {
        max-width: 900px;
        margin: 0 auto;
    }
    .mentor-header {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(0, 0, 0, 0.8));
        border: 2px solid rgba(255, 215, 0, 0.4);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .mentor-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ffd700, #ff8c00);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #1a1a2e;
    }
    .lesson-section {
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.25rem;
    }
    .section-title {
        color: #ffd700;
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .lesson-content {
        color: #e0e0e0;
        font-size: 1rem;
        line-height: 1.8;
    }
    .lesson-content strong {
        color: #ffd700;
    }
    .concept-box {
        background: rgba(33, 150, 243, 0.15);
        border-left: 4px solid #2196F3;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 0 8px 8px 0;
    }
    .concept-box h5 {
        color: #64b5f6;
        margin-bottom: 0.5rem;
    }
    .formula-box {
        background: rgba(156, 39, 176, 0.15);
        border-left: 4px solid #9C27B0;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 0 8px 8px 0;
        font-family: monospace;
    }
    .formula-box h5 {
        color: #ce93d8;
        margin-bottom: 0.5rem;
        font-family: inherit;
    }
    .example-box {
        background: rgba(76, 175, 80, 0.15);
        border-left: 4px solid #4CAF50;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 0 8px 8px 0;
    }
    .example-box h5 {
        color: #81c784;
        margin-bottom: 0.5rem;
    }
    .practice-section {
        background: rgba(255, 152, 0, 0.15);
        border: 2px solid rgba(255, 152, 0, 0.4);
        border-radius: 12px;
        padding: 1.5rem;
    }
    .practice-question {
        color: #e0e0e0;
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }
    .practice-input {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 215, 0, 0.3);
        color: #fff;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        width: 100%;
        font-size: 1rem;
    }
    .practice-input:focus {
        outline: none;
        border-color: #ffd700;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }
    .feedback-correct {
        background: rgba(76, 175, 80, 0.2);
        border: 1px solid #4CAF50;
        color: #c8e6c9;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }
    .feedback-incorrect {
        background: rgba(244, 67, 54, 0.2);
        border: 1px solid #f44336;
        color: #ffcdd2;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }
    .complete-btn {
        background: linear-gradient(135deg, #4CAF50, #45a049);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.2s;
    }
    .complete-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        color: white;
    }
    .complete-btn:disabled {
        background: #666;
        cursor: not-allowed;
        transform: none;
    }
    .progress-indicator {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    .progress-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
    }
    .progress-dot.active {
        background: #ffd700;
    }
    .progress-dot.completed {
        background: #4CAF50;
    }
    .time-estimate {
        color: #b0b0b0;
        font-size: 0.9rem;
    }
</style>

<div class="container py-4 mentor-container">
    <div class="mentor-header">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <div class="mentor-avatar">
                <i class="bi bi-mortarboard-fill"></i>
            </div>
            <div class="flex-grow-1">
                <h3 class="gold-text mb-1">{{ module.module_title }}</h3>
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <span class="badge bg-info">{{ module.discipline }}</span>
                    <span class="time-estimate"><i class="bi bi-clock"></i> ~{{ module.estimated_minutes }} min</span>
                </div>
            </div>
            <a href="{{ url_for('hub') }}" class="btn btn-outline-light">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="progress-indicator">
        <div class="progress-dot" id="dot-theory"></div>
        <div class="progress-dot" id="dot-concepts"></div>
        <div class="progress-dot" id="dot-example"></div>
        <div class="progress-dot" id="dot-practice"></div>
    </div>

    <div class="lesson-section" id="section-theory">
        <div class="section-title">
            <i class="bi bi-book"></i> Understanding the Concept
        </div>
        <div class="lesson-content">
            {{ module.theory_content|safe }}
        </div>
    </div>

    {% if module.key_concepts %}
    <div class="lesson-section" id="section-concepts">
        <div class="section-title">
            <i class="bi bi-lightbulb"></i> Key Concepts
        </div>
        <div class="concept-box">
            <div class="lesson-content">{{ module.key_concepts|safe }}</div>
        </div>
    </div>
    {% endif %}

    {% if module.formulas %}
    <div class="lesson-section" id="section-formulas">
        <div class="section-title">
            <i class="bi bi-calculator"></i> Formulas & Frameworks
        </div>
        <div class="formula-box">
            <div class="lesson-content">{{ module.formulas|safe }}</div>
        </div>
    </div>
    {% endif %}

    {% if module.real_world_example %}
    <div class="lesson-section" id="section-example">
        <div class="section-title">
            <i class="bi bi-building"></i> Real-World Example
        </div>
        <div class="example-box">
            <div class="lesson-content">{{ module.real_world_example|safe }}</div>
        </div>
    </div>
    {% endif %}

    {% if module.practice_question %}
    <div class="practice-section" id="section-practice">
        <div class="section-title">
            <i class="bi bi-pencil-square"></i> Practice Question
        </div>
        <p class="practice-question">{{ module.practice_question }}</p>
        
        <form id="practice-form">
            <input type="text" class="practice-input mb-3" id="practice-answer" 
                   placeholder="Type your answer here..." autocomplete="off">
            <button type="button" class="btn btn-warning" onclick="checkAnswer()">
                <i class="bi bi-check-lg"></i> Check Answer
            </button>
        </form>
        
        <div id="feedback-area"></div>
    </div>
    {% endif %}

    <div class="text-center mt-4">
        <form action="{{ url_for('complete_mentorship_route', module_id=module.module_id) }}" method="post" id="complete-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="scenario_id" value="{{ scenario_id or '' }}">
            <button type="submit" class="complete-btn" id="complete-btn" {% if module.practice_question %}disabled{% endif %}>
                <i class="bi bi-check-circle"></i> Complete Lesson & Continue
            </button>
        </form>
        <p class="mt-2" id="complete-hint" style="color: #b0b0b0;">
            {% if module.practice_question %}
            <small>Answer the practice question to unlock</small>
            {% endif %}
        </p>
    </div>
</div>

<script>
const correctAnswer = "{{ module.practice_answer|default('', true)|e }}";
const explanation = "{{ module.practice_explanation|default('', true)|e }}";

function checkAnswer() {
    const userAnswer = document.getElementById('practice-answer').value.trim().toLowerCase();
    const feedbackArea = document.getElementById('feedback-area');
    const completeBtn = document.getElementById('complete-btn');
    const completeHint = document.getElementById('complete-hint');
    
    if (!userAnswer) {
        feedbackArea.innerHTML = '<div class="feedback-incorrect mt-3"><i class="bi bi-exclamation-circle"></i> Please enter an answer.</div>';
        return;
    }
    
    const correct = correctAnswer.toLowerCase();
    const isCorrect = userAnswer === correct || 
                      userAnswer.includes(correct) || 
                      correct.includes(userAnswer);
    
    if (isCorrect) {
        feedbackArea.innerHTML = `
            <div class="feedback-correct mt-3">
                <h5><i class="bi bi-check-circle-fill"></i> Correct!</h5>
                <p>${explanation}</p>
            </div>
        `;
        completeBtn.disabled = false;
        completeHint.innerHTML = '<small style="color: #81c784;">Great job! You can now continue.</small>';
        document.getElementById('dot-practice').classList.add('completed');
    } else {
        feedbackArea.innerHTML = `
            <div class="feedback-incorrect mt-3">
                <h5><i class="bi bi-x-circle-fill"></i> Not quite right</h5>
                <p>The correct answer is: <strong>${correctAnswer}</strong></p>
                <p>${explanation}</p>
            </div>
        `;
        completeBtn.disabled = false;
        completeHint.innerHTML = '<small>Review the explanation and continue when ready.</small>';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('dot-theory').classList.add('active');
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const sectionId = entry.target.id;
                if (sectionId === 'section-theory') document.getElementById('dot-theory').classList.add('completed');
                if (sectionId === 'section-concepts') document.getElementById('dot-concepts').classList.add('completed');
                if (sectionId === 'section-example') document.getElementById('dot-example').classList.add('completed');
            }
        });
    }, { threshold: 0.5 });
    
    document.querySelectorAll('.lesson-section').forEach(section => observer.observe(section));
});
</script>
{% endblock %}
