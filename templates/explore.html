{% extends "base.html" %}

{% block title %}Explore - Business Tycoon RPG{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
    html, body {
        overflow: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
        background: #000 !important;
        width: 100vw !important;
        height: 100vh !important;
    }
    body::before, body::after { display: none !important; }
    .navbar, footer, .hud-resources-bar, .game-hud, #pwa-install-banner, .alert { display: none !important; }
    body > .container {
        padding: 0 !important; margin: 0 !important;
        max-width: 100vw !important; width: 100vw !important; height: 100vh !important;
        position: fixed !important; top: 0 !important; left: 0 !important;
    }
    #explore-container {
        position: fixed !important; top: 0; left: 0;
        width: 100vw !important; height: 100vh !important;
        background: #000; z-index: 10;
    }
    #game-canvas {
        display: block; width: 100vw; height: 100vh;
        image-rendering: pixelated; image-rendering: crisp-edges;
    }
    #dpad {
        position: fixed; bottom: 30px; left: 24px;
        width: 150px; height: 150px; z-index: 200; display: none;
    }
    .dpad-btn {
        position: absolute; width: 48px; height: 48px;
        background: linear-gradient(180deg, #303080 0%, #181850 100%);
        border: 2px solid #8080c0; border-radius: 4px;
        color: #c0c0e0; font-size: 18px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; user-select: none; -webkit-user-select: none;
        touch-action: none; font-family: 'Press Start 2P', monospace;
        box-shadow: 0 2px 4px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.15);
    }
    .dpad-btn:active { background: linear-gradient(180deg, #4040a0 0%, #282870 100%); border-color: #a0a0e0; }
    #dpad-up { top: 0; left: 51px; }
    #dpad-down { bottom: 0; left: 51px; }
    #dpad-left { top: 51px; left: 0; }
    #dpad-right { top: 51px; right: 0; }
    .dpad-center { position: absolute; top: 51px; left: 51px; width: 48px; height: 48px; background: #202060; border-radius: 4px; }
    #action-buttons { position: fixed; bottom: 40px; right: 24px; z-index: 200; display: none; }
    .action-btn-ff {
        width: 56px; height: 56px;
        background: linear-gradient(180deg, #303080 0%, #181850 100%);
        border: 2px solid #8080c0; border-radius: 50%;
        color: #e0e0f0; font-size: 11px; font-weight: bold;
        cursor: pointer; user-select: none; -webkit-user-select: none;
        touch-action: none; font-family: 'Press Start 2P', monospace;
        box-shadow: 0 2px 6px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.15);
        margin: 4px;
    }
    .action-btn-ff:active { background: linear-gradient(180deg, #4040a0 0%, #282870 100%); }
    #btn-menu {
        position: fixed; top: 56px; right: 12px;
        width: 44px; height: 44px;
        background: linear-gradient(180deg, #181888 0%, #080840 100%);
        border: 2px solid #8888c0; border-radius: 4px;
        color: #c0c0e0; font-size: 16px; cursor: pointer; z-index: 300;
        display: flex; align-items: center; justify-content: center;
        font-family: 'Press Start 2P', monospace;
        box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    #loading-screen {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: #000; display: flex; flex-direction: column;
        align-items: center; justify-content: center; z-index: 1000;
        color: #c0c0e0; font-family: 'Press Start 2P', monospace;
    }
    #loading-screen h2 { color: #f0d850; font-size: 18px; margin-bottom: 8px; text-shadow: 2px 2px 0 #000030; }
    #loading-screen p { font-size: 10px; margin-bottom: 24px; color: #8080c0; }
    .loading-bar { width: 280px; height: 16px; border: 2px solid #8888c0; border-radius: 2px; overflow: hidden; background: #080840; }
    .loading-fill {
        height: 100%; background: linear-gradient(90deg, #2040a8, #4060c8, #2040a8);
        background-size: 200% 100%; width: 0%;
        animation: loadAnim 1.8s ease-out forwards, shimmer 1s linear infinite;
    }
    @keyframes loadAnim { 0% { width: 0%; } 100% { width: 100%; } }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @keyframes cursorBob { from { transform: translateX(0); } to { transform: translateX(3px); } }
    @media (pointer: coarse), (max-width: 768px) {
        #dpad, #action-buttons { display: flex; }
        #action-buttons { flex-direction: column; align-items: center; }
    }

    .ff-overlay {
        display: none; position: fixed; top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0,0,20,0.80); z-index: 500;
        font-family: 'Press Start 2P', monospace;
    }
    .ff-overlay.active { display: flex; align-items: center; justify-content: center; }
    .ff-panel {
        background: linear-gradient(180deg, #181888 0%, #101060 30%, #080840 100%);
        border: 3px solid #e8e8f0; border-radius: 4px;
        box-shadow: inset 0 0 0 3px #484888, 0 0 40px rgba(0,0,100,0.5);
        padding: 0; max-width: 90vw; max-height: 85vh; overflow: hidden;
        display: flex; flex-direction: column;
    }
    .ff-panel-header {
        padding: 14px 20px; border-bottom: 2px solid #484888;
        display: flex; align-items: center; justify-content: space-between;
    }
    .ff-panel-title {
        color: #f0d850; font-size: 13px;
        text-shadow: 2px 2px 0 #000030; margin: 0;
    }
    .ff-panel-close {
        background: none; border: none; color: #8080c0; font-size: 11px;
        cursor: pointer; font-family: 'Press Start 2P', monospace; padding: 4px 8px;
    }
    .ff-panel-close:hover { color: #e8e8f0; }
    .ff-panel-body {
        padding: 16px 20px; overflow-y: auto; flex: 1;
        max-height: 65vh; scrollbar-width: thin; scrollbar-color: #484888 #101060;
    }
    .ff-panel-body::-webkit-scrollbar { width: 8px; }
    .ff-panel-body::-webkit-scrollbar-track { background: #101060; }
    .ff-panel-body::-webkit-scrollbar-thumb { background: #484888; border-radius: 4px; }
    .ff-list-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: 10px 12px; margin: 4px 0; cursor: pointer;
        border: 1px solid transparent; border-radius: 2px;
        transition: all 0.1s;
    }
    .ff-list-item:hover { border-color: #8080c0; background: rgba(80,80,160,0.25); }
    .ff-list-item.completed { opacity: 0.5; }
    .ff-list-item-name {
        color: #e0e0f0; font-size: 10px;
        text-shadow: 1px 1px 0 #000030; flex: 1;
    }
    .ff-list-item-detail { color: #8080c0; font-size: 9px; margin-left: 12px; white-space: nowrap; }
    .ff-list-item-stars { color: #f0d850; font-size: 9px; margin-left: 8px; }
    .ff-list-item-price { color: #e8c020; font-size: 10px; margin-left: 12px; }
    .ff-btn {
        background: linear-gradient(180deg, #303080 0%, #181850 100%);
        border: 2px solid #8080c0; border-radius: 4px;
        color: #e0e0f0; font-size: 10px; padding: 8px 16px;
        cursor: pointer; font-family: 'Press Start 2P', monospace;
        transition: all 0.1s;
    }
    .ff-btn:hover { background: linear-gradient(180deg, #4040a0 0%, #282870 100%); border-color: #a0a0e0; }
    .ff-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .ff-gold { color: #e8c020; }
    .ff-green { color: #40d840; }
    .ff-red { color: #e84040; }
    .ff-blue { color: #50a0f0; }
    .ff-label { color: #8080c0; font-size: 9px; margin-bottom: 4px; }
    .ff-value { color: #e0e0f0; font-size: 11px; }
    .ff-stat-row {
        display: flex; align-items: center; justify-content: space-between;
        padding: 6px 0; border-bottom: 1px solid #282860;
    }
    .ff-stat-row:last-child { border-bottom: none; }
    .ff-bar-bg {
        width: 120px; height: 10px; background: #101040;
        border: 1px solid #484888; border-radius: 2px; overflow: hidden;
    }
    .ff-bar-fill { height: 100%; border-radius: 1px; transition: width 0.3s; }
    .ff-scenario-detail {
        padding: 16px; border: 1px solid #484888; border-radius: 4px;
        margin-top: 12px; background: rgba(16,16,80,0.5);
    }
    .ff-scenario-desc { color: #c0c0e0; font-size: 9px; line-height: 1.8; margin: 8px 0 16px; }
    .ff-choice-btn {
        display: block; width: 100%; text-align: left;
        background: rgba(40,40,100,0.5); border: 1px solid #484888;
        border-radius: 3px; color: #e0e0f0; font-size: 9px;
        padding: 10px 14px; margin: 6px 0; cursor: pointer;
        font-family: 'Press Start 2P', monospace; transition: all 0.1s;
    }
    .ff-choice-btn:hover { border-color: #a0a0e0; background: rgba(60,60,140,0.5); }
    .ff-result-box {
        padding: 16px; border: 2px solid #484888; border-radius: 4px;
        margin-top: 12px; background: rgba(8,8,40,0.8); text-align: center;
    }
    .ff-result-box h4 { color: #f0d850; font-size: 12px; margin: 0 0 12px; }
    .ff-result-stat { color: #c0c0e0; font-size: 10px; margin: 6px 0; }

    .ff-menu-overlay {
        display: none; position: fixed; top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0,0,20,0.85); z-index: 600;
        font-family: 'Press Start 2P', monospace;
    }
    .ff-menu-overlay.active { display: flex; }
    .ff-menu-left {
        width: 260px; height: 100vh;
        background: linear-gradient(180deg, #181888 0%, #101060 30%, #080840 100%);
        border-right: 3px solid #e8e8f0;
        box-shadow: inset -3px 0 0 #484888;
        display: flex; flex-direction: column; padding: 0;
    }
    .ff-menu-header {
        padding: 20px; border-bottom: 2px solid #484888;
        text-align: center;
    }
    .ff-menu-header h2 {
        color: #f0d850; font-size: 14px; margin: 0;
        text-shadow: 2px 2px 0 #000030;
    }
    .ff-menu-item {
        display: block; width: 100%; padding: 14px 20px 14px 36px;
        background: transparent; border: none;
        color: #c0c0e0; font-family: 'Press Start 2P', monospace;
        font-size: 11px; cursor: pointer; text-align: left;
        position: relative; transition: color 0.1s;
    }
    .ff-menu-item:hover { color: #ffffff; }
    .ff-menu-item:hover::before {
        content: '\25B6'; position: absolute; left: 14px;
        color: #e8e8f0; animation: cursorBob 0.4s ease-in-out infinite alternate;
    }
    .ff-menu-sep { border: none; border-top: 1px solid #484888; margin: 8px 16px; }
    .ff-menu-right {
        flex: 1; padding: 20px; overflow-y: auto;
        display: flex; flex-direction: column;
    }
    .ff-menu-right-panel {
        background: linear-gradient(180deg, #181888 0%, #101060 30%, #080840 100%);
        border: 3px solid #e8e8f0; border-radius: 4px;
        box-shadow: inset 0 0 0 3px #484888;
        padding: 20px; flex: 1; overflow-y: auto;
    }

    .ff-toast {
        position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
        background: linear-gradient(180deg, #181888 0%, #080840 100%);
        border: 2px solid #e8e8f0; border-radius: 4px;
        padding: 12px 24px; color: #e0e0f0; font-size: 10px;
        font-family: 'Press Start 2P', monospace; z-index: 700;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        animation: toastIn 0.3s ease-out;
    }
    @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
</style>
{% endblock %}

{% block content %}
<div id="loading-screen">
    <h2>BUSINESS TYCOON</h2>
    <p>Loading...</p>
    <div class="loading-bar"><div class="loading-fill"></div></div>
</div>

<div id="explore-container">
    <canvas id="game-canvas" tabindex="0"></canvas>
</div>

<div id="dpad">
    <div class="dpad-center"></div>
    <div class="dpad-btn" id="dpad-up">&#9650;</div>
    <div class="dpad-btn" id="dpad-down">&#9660;</div>
    <div class="dpad-btn" id="dpad-left">&#9664;</div>
    <div class="dpad-btn" id="dpad-right">&#9654;</div>
</div>
<div id="action-buttons">
    <button class="action-btn-ff" id="btn-action">A</button>
    <button class="action-btn-ff" id="btn-cancel" style="font-size:10px;">B</button>
</div>

<button id="btn-menu" onclick="openMenu()">&#9776;</button>

<div id="overlay-scenarios" class="ff-overlay">
    <div class="ff-panel" style="width: 520px;">
        <div class="ff-panel-header">
            <h3 class="ff-panel-title" id="scenarios-title">Quests</h3>
            <button class="ff-panel-close" onclick="closeOverlay('scenarios')">&#10005; Close</button>
        </div>
        <div class="ff-panel-body" id="scenarios-body"></div>
    </div>
</div>

<div id="overlay-shop" class="ff-overlay">
    <div class="ff-panel" style="width: 480px;">
        <div class="ff-panel-header">
            <h3 class="ff-panel-title">Item Shop</h3>
            <span class="ff-panel-title" id="shop-gold" style="font-size:11px;"></span>
            <button class="ff-panel-close" onclick="closeOverlay('shop')">&#10005; Close</button>
        </div>
        <div class="ff-panel-body" id="shop-body"></div>
    </div>
</div>

<div id="overlay-scenario-play" class="ff-overlay">
    <div class="ff-panel" style="width: 560px;">
        <div class="ff-panel-header">
            <h3 class="ff-panel-title" id="play-title">Scenario</h3>
            <button class="ff-panel-close" onclick="closeOverlay('scenario-play')">&#10005; Close</button>
        </div>
        <div class="ff-panel-body" id="play-body"></div>
    </div>
</div>

<div id="overlay-dashboard" class="ff-overlay">
    <div class="ff-panel" style="width: 700px; max-width: 95vw;">
        <div class="ff-panel-header">
            <h3 class="ff-panel-title">Command Center</h3>
            <button class="ff-panel-close" onclick="closeOverlay('dashboard')">&#10005; Close</button>
        </div>
        <div class="ff-panel-body" id="dashboard-body" style="max-height: 75vh;">
            <p style="color:#8080c0; font-size:10px;">Loading...</p>
        </div>
    </div>
</div>

<div id="ff-menu" class="ff-menu-overlay">
    <div class="ff-menu-left">
        <div class="ff-menu-header"><h2>MENU</h2></div>
        <button class="ff-menu-item" onclick="showMenuPanel('status')">Status</button>
        <button class="ff-menu-item" onclick="showMenuPanel('skills')">Skills</button>
        <button class="ff-menu-item" onclick="showMenuPanel('items')">Items</button>
        <hr class="ff-menu-sep">
        <button class="ff-menu-item" onclick="closeMenu(); openDashboard();">Command Center</button>
        <hr class="ff-menu-sep">
        <button class="ff-menu-item" onclick="closeMenu()">Resume</button>
    </div>
    <div class="ff-menu-right">
        <div class="ff-menu-right-panel" id="menu-right-content">
            <p style="color:#8080c0; font-size:10px; text-align:center; margin-top:40px;">Select an option from the menu.</p>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/rpg/engine.js') }}"></script>
<script src="{{ url_for('static', filename='js/rpg/maps.js') }}"></script>
<script>
const gameData = {
    capital: {{ resources.capital | default(10000) }},
    morale: {{ resources.morale | default(80) }},
    brand: {{ resources.brand_equity | default(100) }},
    quarter: {{ resources.fiscal_quarter | default(1) }},
    energy: {{ energy.current_energy | default(100) }}
};

const csrfToken = '{{ csrf_token() }}';

function showToast(msg, duration) {
    const t = document.createElement('div');
    t.className = 'ff-toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, duration || 2500);
}

function openOverlay(id) {
    document.getElementById('overlay-' + id).classList.add('active');
    RPGEngine.setOverlayActive(true);
}
function closeOverlay(id) {
    document.getElementById('overlay-' + id).classList.remove('active');
    RPGEngine.setOverlayActive(false);
    document.getElementById('game-canvas').focus();
}

let menuOpen = false;
function openMenu() {
    menuOpen = true;
    document.getElementById('ff-menu').classList.add('active');
    RPGEngine.setOverlayActive(true);
    document.getElementById('menu-right-content').innerHTML =
        '<p style="color:#8080c0; font-size:10px; text-align:center; margin-top:40px;">Select an option from the menu.</p>';
}
function closeMenu() {
    menuOpen = false;
    document.getElementById('ff-menu').classList.remove('active');
    RPGEngine.setOverlayActive(false);
    document.getElementById('game-canvas').focus();
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const dashO = document.getElementById('overlay-dashboard');
        const scenO = document.getElementById('overlay-scenarios');
        const shopO = document.getElementById('overlay-shop');
        const playO = document.getElementById('overlay-scenario-play');
        if (playO.classList.contains('active')) { closeOverlay('scenario-play'); e.preventDefault(); return; }
        if (dashO.classList.contains('active')) { closeOverlay('dashboard'); e.preventDefault(); return; }
        if (scenO.classList.contains('active')) { closeOverlay('scenarios'); e.preventDefault(); return; }
        if (shopO.classList.contains('active')) { closeOverlay('shop'); e.preventDefault(); return; }
        if (menuOpen) { closeMenu(); } else { openMenu(); }
        e.preventDefault();
    }
});

async function showMenuPanel(panel) {
    const el = document.getElementById('menu-right-content');
    el.innerHTML = '<p style="color:#8080c0; font-size:10px; text-align:center;">Loading...</p>';
    try {
        const res = await fetch('/api/stats');
        const data = await res.json();
        const s = data.stats;
        const e = data.energy;
        const r = data.resources;
        if (panel === 'status') {
            el.innerHTML = `
                <div style="margin-bottom:16px;">
                    <div class="ff-stat-row"><span class="ff-label">Name</span><span class="ff-value">${s.name || 'Hero'}</span></div>
                    <div class="ff-stat-row"><span class="ff-label">Title</span><span class="ff-value">${s.job_title || 'Apprentice'}</span></div>
                    <div class="ff-stat-row"><span class="ff-label">Career</span><span class="ff-value">${s.career_path || 'General'}</span></div>
                    <div class="ff-stat-row"><span class="ff-label">Gold</span><span class="ff-value ff-gold">${Number(s.cash || 0).toLocaleString()}</span></div>
                    <div class="ff-stat-row"><span class="ff-label">Reputation</span><span class="ff-value ff-blue">${s.reputation || 0}</span></div>
                    <div class="ff-stat-row"><span class="ff-label">Energy</span><span class="ff-value">${e ? e.current_energy : '?'} / ${e ? e.max_energy : '?'}</span></div>
                    <div class="ff-stat-row"><span class="ff-label">Quarter</span><span class="ff-value">Q${r ? r.fiscal_quarter : '?'}</span></div>
                </div>
                ${s.character_stats ? `
                <h4 style="color:#f0d850; font-size:10px; margin:12px 0 8px;">Attributes</h4>
                ${Object.entries(s.character_stats).map(([k,v]) =>
                    `<div class="ff-stat-row"><span class="ff-label">${k}</span><span class="ff-value">${v}</span></div>`
                ).join('')}` : ''}
            `;
        } else if (panel === 'skills') {
            const discs = s.disciplines || {};
            el.innerHTML = `
                <h4 style="color:#f0d850; font-size:10px; margin:0 0 12px;">Business Skills</h4>
                ${Object.entries(discs).map(([name, d]) => `
                    <div class="ff-stat-row">
                        <div>
                            <div class="ff-value" style="font-size:10px;">${name}</div>
                            <div class="ff-label" style="margin-top:2px;">Lv.${d.level} ${d.title || ''}</div>
                        </div>
                        <div style="text-align:right;">
                            <div class="ff-bar-bg" style="width:100px;">
                                <div class="ff-bar-fill" style="width:${d.progress_bar || 0}%; background:#50a0f0;"></div>
                            </div>
                            <div class="ff-label" style="margin-top:2px;">EXP: ${d.total_exp || 0}</div>
                        </div>
                    </div>
                `).join('')}
            `;
        } else if (panel === 'items') {
            const inv = s.inventory || [];
            if (inv.length === 0) {
                el.innerHTML = '<p style="color:#8080c0; font-size:10px; text-align:center; margin-top:20px;">No items in inventory.</p>';
            } else {
                el.innerHTML = `
                    <h4 style="color:#f0d850; font-size:10px; margin:0 0 12px;">Inventory</h4>
                    ${inv.map(item => `
                        <div class="ff-list-item">
                            <span class="ff-list-item-name">${item.item_name || item.name || 'Item'}</span>
                            <span class="ff-list-item-detail">x${item.quantity || 1}</span>
                        </div>
                    `).join('')}
                `;
            }
        }
        gameData.capital = s.cash || gameData.capital;
        gameData.energy = e ? e.current_energy : gameData.energy;
        RPGEngine.updateHUD(gameData);
    } catch(err) {
        el.innerHTML = '<p style="color:#e84040; font-size:10px;">Failed to load data.</p>';
    }
}

async function openScenarios(discipline) {
    const body = document.getElementById('scenarios-body');
    document.getElementById('scenarios-title').textContent = discipline + ' Quests';
    body.innerHTML = '<p style="color:#8080c0; font-size:10px;">Loading quests...</p>';
    openOverlay('scenarios');
    try {
        const res = await fetch('/api/scenarios/' + encodeURIComponent(discipline));
        const data = await res.json();
        const scenarios = data.scenarios || [];
        if (scenarios.length === 0) {
            body.innerHTML = '<p style="color:#8080c0; font-size:10px;">No quests available yet. Level up to unlock more!</p>';
            return;
        }
        body.innerHTML = scenarios.map(sc => {
            const done = sc.is_completed;
            const stars = sc.stars_earned || 0;
            const starStr = stars > 0 ? '&#9733;'.repeat(stars) + '&#9734;'.repeat(3 - stars) : '';
            return `
                <div class="ff-list-item ${done ? 'completed' : ''}" onclick="${done ? '' : `openScenarioPlay(${sc.scenario_id})`}" style="${done ? 'cursor:default;' : ''}">
                    <div>
                        <div class="ff-list-item-name">${sc.scenario_name || sc.title || 'Quest'}</div>
                        <div class="ff-list-item-detail" style="margin-left:0; margin-top:4px;">Lv.${sc.required_level || 1}${done ? ' - Completed' : ''}</div>
                    </div>
                    <div style="text-align:right;">
                        ${starStr ? `<div class="ff-list-item-stars">${starStr}</div>` : ''}
                        ${!done ? '<div class="ff-list-item-detail" style="color:#50a0f0;">Enter &gt;</div>' : ''}
                    </div>
                </div>
            `;
        }).join('');
    } catch(err) {
        body.innerHTML = '<p style="color:#e84040; font-size:10px;">Failed to load quests.</p>';
    }
}

async function openScenarioPlay(scenarioId) {
    const body = document.getElementById('play-body');
    body.innerHTML = '<p style="color:#8080c0; font-size:10px;">Loading...</p>';
    openOverlay('scenario-play');
    try {
        const res = await fetch('/api/play/' + scenarioId);
        const data = await res.json();
        if (data.error) {
            body.innerHTML = `<p style="color:#e84040; font-size:10px;">${data.error}</p>`;
            return;
        }
        const sc = data.scenario;
        document.getElementById('play-title').textContent = sc.scenario_name || sc.title || 'Quest';
        body.innerHTML = `
            <div class="ff-scenario-desc">${sc.description || sc.scenario_text || 'A business challenge awaits...'}</div>
            <div style="margin-top: 16px;">
                <h4 style="color:#f0d850; font-size:10px; margin-bottom:12px;">Choose your approach:</h4>
                <button class="ff-choice-btn" onclick="makeChoice(${sc.scenario_id}, 'A')">
                    <span class="ff-gold">A.</span> ${sc.choice_a_text || sc.choice_a || 'Option A'}
                </button>
                <button class="ff-choice-btn" onclick="makeChoice(${sc.scenario_id}, 'B')">
                    <span class="ff-gold">B.</span> ${sc.choice_b_text || sc.choice_b || 'Option B'}
                </button>
                ${sc.choice_c_text || sc.choice_c ? `
                <button class="ff-choice-btn" onclick="makeChoice(${sc.scenario_id}, 'C')">
                    <span class="ff-gold">C.</span> ${sc.choice_c_text || sc.choice_c || 'Option C'}
                </button>` : ''}
            </div>
        `;
    } catch(err) {
        body.innerHTML = '<p style="color:#e84040; font-size:10px;">Failed to load scenario.</p>';
    }
}

async function makeChoice(scenarioId, choice) {
    const body = document.getElementById('play-body');
    body.innerHTML = '<p style="color:#8080c0; font-size:10px;">Processing...</p>';
    try {
        const res = await fetch(`/api/choose/${scenarioId}/${choice}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
        });
        const data = await res.json();
        if (data.error || (data.result && data.result.error)) {
            body.innerHTML = `<p style="color:#e84040; font-size:10px;">${data.error || data.result.error}</p>
            <button class="ff-btn" onclick="closeOverlay('scenario-play')" style="margin-top:12px;">Close</button>`;
            return;
        }
        const r = data.result;
        body.innerHTML = `
            <div class="ff-result-box">
                <h4>${r.feedback ? 'Result' : 'Quest Complete!'}</h4>
                ${r.feedback ? `<p class="ff-scenario-desc">${r.feedback}</p>` : ''}
                ${r.exp_gained ? `<p class="ff-result-stat ff-green">+${r.exp_gained} EXP</p>` : ''}
                ${r.cash_change ? `<p class="ff-result-stat ${r.cash_change >= 0 ? 'ff-gold' : 'ff-red'}">${r.cash_change >= 0 ? '+' : ''}${Number(r.cash_change).toLocaleString()} Gold</p>` : ''}
                ${r.reputation_change ? `<p class="ff-result-stat ff-blue">${r.reputation_change >= 0 ? '+' : ''}${r.reputation_change} Reputation</p>` : ''}
                ${r.stars_earned ? `<p class="ff-result-stat" style="color:#f0d850;">${'&#9733;'.repeat(r.stars_earned)} Stars</p>` : ''}
            </div>
            <button class="ff-btn" onclick="closeAllOverlays()" style="margin-top:16px; display:block; margin-left:auto; margin-right:auto;">Continue</button>
        `;
        if (data.stats) {
            gameData.capital = data.stats.cash || gameData.capital;
        }
        if (data.energy) {
            gameData.energy = data.energy.current_energy || gameData.energy;
        }
        if (data.resources) {
            gameData.morale = data.resources.morale || gameData.morale;
            gameData.brand = data.resources.brand_equity || gameData.brand;
            gameData.quarter = data.resources.fiscal_quarter || gameData.quarter;
        }
        RPGEngine.updateHUD(gameData);
    } catch(err) {
        body.innerHTML = `<p style="color:#e84040; font-size:10px;">Error processing choice.</p>
        <button class="ff-btn" onclick="closeOverlay('scenario-play')" style="margin-top:12px;">Close</button>`;
    }
}

function closeAllOverlays() {
    closeOverlay('scenario-play');
    closeOverlay('scenarios');
    closeOverlay('shop');
    closeOverlay('dashboard');
}

async function openDashboard() {
    const body = document.getElementById('dashboard-body');
    body.innerHTML = '<p style="color:#8080c0; font-size:10px;">Loading Command Center...</p>';
    openOverlay('dashboard');
    try {
        const res = await fetch('/api/dashboard');
        const data = await res.json();
        const d = data.dashboard || {};
        const r = d.resources || {};
        const radar = d.radar_data || {};
        const news = d.news_ticker || [];
        const skills = d.skill_tree || [];
        const abilities = d.active_abilities || [];
        const s = data.stats || {};
        const e = data.energy || {};
        const milestones = data.milestones || {};
        const rivals = data.rivals || [];

        const maxLevel = 10;
        const radarLabels = Object.keys(radar);
        const radarValues = Object.values(radar);

        let radarHTML = '<div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">';
        radarLabels.forEach((label, i) => {
            const pct = Math.round((radarValues[i] / maxLevel) * 100);
            radarHTML += `
                <div style="flex:1; min-width:120px;">
                    <div class="ff-label">${label}</div>
                    <div class="ff-bar-bg" style="width:100%; margin-top:4px;">
                        <div class="ff-bar-fill" style="width:${pct}%; background: ${getSkillColor(i)};"></div>
                    </div>
                    <div style="color:#c0c0e0; font-size:9px; margin-top:2px;">Lv.${radarValues[i]}</div>
                </div>
            `;
        });
        radarHTML += '</div>';

        let newsHTML = '';
        if (news.length > 0) {
            newsHTML = news.map(n => `
                <div style="padding:6px 0; border-bottom:1px solid #282860;">
                    <span style="color:#f0d850; font-size:9px;">&#9670;</span>
                    <span style="color:#c0c0e0; font-size:9px; margin-left:6px;">${n.message || n}</span>
                </div>
            `).join('');
        } else {
            newsHTML = '<p style="color:#8080c0; font-size:9px;">Welcome to your business journey! Make decisions to see market updates here.</p>';
        }

        let abilitiesHTML = '';
        if (abilities.length > 0) {
            abilitiesHTML = `
                <div style="margin-top:16px; padding-top:12px; border-top:2px solid #484888;">
                    <h4 style="color:#f0d850; font-size:10px; margin:0 0 8px;">Active Abilities</h4>
                    ${abilities.map(a => `
                        <div class="ff-stat-row">
                            <span class="ff-value" style="font-size:9px;">${a.name || a.ability_name || 'Ability'}</span>
                            <span class="ff-label">${a.remaining || ''}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        let rivalsHTML = '';
        if (rivals.length > 0) {
            rivalsHTML = `
                <div style="margin-top:16px; padding-top:12px; border-top:2px solid #484888;">
                    <h4 style="color:#f0d850; font-size:10px; margin:0 0 8px;">Rivals</h4>
                    ${rivals.slice(0, 3).map(rv => `
                        <div class="ff-stat-row">
                            <span class="ff-value" style="font-size:9px;">${rv.rival_name || rv.name || 'Rival'}</span>
                            <span class="ff-label">${rv.difficulty || ''}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        body.innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                <div>
                    <h4 style="color:#f0d850; font-size:10px; margin:0 0 12px;">&#128188; Resource Ledger</h4>
                    <div class="ff-stat-row">
                        <span class="ff-label">$ Capital</span>
                        <span class="ff-value ff-gold">$${Number(r.capital || s.cash || 0).toLocaleString()}</span>
                    </div>
                    <div class="ff-stat-row">
                        <span class="ff-label">Team Morale</span>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div class="ff-bar-bg">
                                <div class="ff-bar-fill" style="width:${r.morale || 0}%; background:#50a0f0;"></div>
                            </div>
                            <span class="ff-value" style="font-size:9px;">${r.morale || 0}%</span>
                        </div>
                    </div>
                    <div class="ff-stat-row">
                        <span class="ff-label">Brand Equity</span>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div class="ff-bar-bg">
                                <div class="ff-bar-fill" style="width:${Math.min(r.brand_equity || 0, 100)}%; background:#e84040;"></div>
                            </div>
                            <span class="ff-value" style="font-size:9px;">${r.brand_equity || 0}%</span>
                        </div>
                    </div>
                    <div class="ff-stat-row">
                        <span class="ff-label">Energy</span>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div class="ff-bar-bg">
                                <div class="ff-bar-fill" style="width:${e.current_energy ? Math.round((e.current_energy / (e.max_energy || 100)) * 100) : 0}%; background:#40d840;"></div>
                            </div>
                            <span class="ff-value" style="font-size:9px;">${e.current_energy || 0}/${e.max_energy || 100}</span>
                        </div>
                    </div>
                    <div class="ff-stat-row">
                        <span class="ff-label">Fiscal Quarter</span>
                        <span class="ff-value">Q${r.fiscal_quarter || 1}</span>
                    </div>
                    <div class="ff-stat-row">
                        <span class="ff-label">Decisions</span>
                        <span class="ff-value">${r.decisions_this_quarter || 0}/3</span>
                    </div>
                    ${abilitiesHTML}
                    ${rivalsHTML}
                </div>
                <div>
                    <h4 style="color:#f0d850; font-size:10px; margin:0 0 12px;">&#127919; Six Pillars of Business</h4>
                    ${radarHTML}
                    <div style="margin-top:20px; padding-top:12px; border-top:2px solid #484888;">
                        <h4 style="color:#f0d850; font-size:10px; margin:0 0 8px;">&#128240; Market News</h4>
                        ${newsHTML}
                    </div>
                </div>
            </div>
        `;

        gameData.capital = r.capital || s.cash || gameData.capital;
        gameData.morale = r.morale || gameData.morale;
        gameData.brand = r.brand_equity || gameData.brand;
        gameData.quarter = r.fiscal_quarter || gameData.quarter;
        gameData.energy = e.current_energy || gameData.energy;
        RPGEngine.updateHUD(gameData);
    } catch(err) {
        body.innerHTML = '<p style="color:#e84040; font-size:10px;">Failed to load Command Center data.</p>';
    }
}

function getSkillColor(index) {
    const colors = ['#e84040', '#f0a030', '#50a0f0', '#40d840', '#c050e0', '#f0d850'];
    return colors[index % colors.length];
}

async function openShop() {
    const body = document.getElementById('shop-body');
    body.innerHTML = '<p style="color:#8080c0; font-size:10px;">Loading shop...</p>';
    openOverlay('shop');
    try {
        const res = await fetch('/api/shop');
        const data = await res.json();
        document.getElementById('shop-gold').textContent = 'Gold: ' + Number(data.cash || 0).toLocaleString();
        const items = data.items || [];
        if (items.length === 0) {
            body.innerHTML = '<p style="color:#8080c0; font-size:10px;">No items available.</p>';
            return;
        }
        body.innerHTML = items.map(item => `
            <div class="ff-list-item">
                <div>
                    <div class="ff-list-item-name">${item.item_name || item.name}</div>
                    <div class="ff-list-item-detail" style="margin-left:0; margin-top:4px;">${item.description || item.effect_description || ''}</div>
                </div>
                <div style="display:flex; align-items:center;">
                    <span class="ff-list-item-price">${Number(item.purchase_price || item.price || 0).toLocaleString()}G</span>
                    <button class="ff-btn" onclick="buyItem(${item.item_id || item.id})" style="margin-left:12px; font-size:9px; padding:6px 10px;">Buy</button>
                </div>
            </div>
        `).join('');
    } catch(err) {
        body.innerHTML = '<p style="color:#e84040; font-size:10px;">Failed to load shop.</p>';
    }
}

async function buyItem(itemId) {
    try {
        const res = await fetch('/api/buy/' + itemId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
        });
        const data = await res.json();
        if (data.error) {
            showToast(data.error);
        } else {
            showToast('Purchased ' + (data.item ? data.item.item_name : 'item') + '!');
            gameData.capital = data.new_cash || gameData.capital;
            RPGEngine.updateHUD(gameData);
            openShop();
        }
    } catch(err) {
        showToast('Purchase failed.');
    }
}

const disciplineMap = {
    'marketing': 'Marketing',
    'finance': 'Finance',
    'operations': 'Operations',
    'hr': 'Human Resources',
    'legal': 'Legal',
    'strategy': 'Strategy'
};

function handleNPCInteract(npc) {
    if (!npc.action) return;
    const action = npc.action.toLowerCase();
    if (action === 'shop' || action === 'equipment') {
        openShop();
    } else if (disciplineMap[action]) {
        openScenarios(disciplineMap[action]);
    } else if (action === 'tutorial') {
        openScenarios('Marketing');
    } else if (action === 'dashboard' || action === 'command') {
        openDashboard();
    } else if (action === 'guild' || action === 'hub') {
        openMenu();
        showMenuPanel('status');
    }
}

function handleTransition(target, spawnX, spawnY) {
    if (target === 'world_map') {
        openMenu();
        showMenuPanel('status');
        return;
    }
    const map = RPGMaps.getMap(target);
    if (map) {
        RPGEngine.loadMap(map, spawnX, spawnY);
    }
}

setTimeout(function() {
    document.getElementById('loading-screen').style.display = 'none';
    RPGEngine.init('game-canvas', {
        onInteract: handleNPCInteract,
        onTransition: handleTransition,
        hudData: gameData
    });
    const startMap = RPGMaps.getMap('{{ current_map | default("hub") }}');
    RPGEngine.loadMap(startMap);
    RPGEngine.start();
    const gc = document.getElementById('game-canvas');
    gc.focus();
    document.addEventListener('click', function() { gc.focus(); });
    document.addEventListener('touchstart', function() { gc.focus(); });
}, 2000);
</script>
{% endblock %}
