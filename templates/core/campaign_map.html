{% extends "core/base.html" %}

{% block title %}Campaign Map - Business Tycoon RPG{% endblock %}

{% block body_class %}world-{{ stats.world|lower }}{% endblock %}

{% block content %}
<div class="campaign-container">
    {% if resources %}
    <div class="command-hud">
        <div class="hud-resources">
            <div class="resource-item capital">
                <i class="bi bi-coin"></i>
                <div class="resource-info">
                    <span class="resource-label">Capital</span>
                    <span class="resource-value">${{ "{:,.0f}".format(resources.capital) }}</span>
                </div>
            </div>
            <div class="resource-item morale">
                <i class="bi bi-emoji-smile"></i>
                <div class="resource-info">
                    <span class="resource-label">Morale</span>
                    <div class="resource-bar-wrap">
                        <div class="resource-bar bg-info" style="width: {{ resources.team_morale }}%;"></div>
                    </div>
                    <span class="resource-pct">{{ resources.team_morale }}%</span>
                </div>
            </div>
            <div class="resource-item brand">
                <i class="bi bi-heart-fill"></i>
                <div class="resource-info">
                    <span class="resource-label">Brand HP</span>
                    <div class="resource-bar-wrap">
                        <div class="resource-bar bg-danger" style="width: {{ resources.brand_equity }}%;"></div>
                    </div>
                    <span class="resource-pct">{{ resources.brand_equity }}%</span>
                </div>
            </div>
            <div class="resource-item quarter">
                <i class="bi bi-calendar3"></i>
                <div class="resource-info">
                    <span class="resource-label">Quarter</span>
                    <span class="resource-value quarter-badge">Q{{ resources.fiscal_quarter }}</span>
                    <span class="decision-count">{{ resources.decisions_this_quarter }}/3</span>
                </div>
            </div>
        </div>
        {% if active_abilities %}
        <div class="active-buffs">
            <span class="buff-label"><i class="bi bi-stars"></i> Active:</span>
            {% for ability in active_abilities %}
            <span class="buff-chip" title="{{ ability.description }}">
                <i class="bi bi-{{ ability.icon }}"></i> {{ ability.ability_name }}
            </span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    <div class="map-header">
        <h1 class="map-title">
            <i class="bi bi-map-fill"></i> CAMPAIGN
        </h1>
        <div class="map-nav">
            <a href="{{ url_for('core.hub') }}" class="map-btn">
                <i class="bi bi-house-door-fill"></i>
            </a>
            <a href="{{ url_for('core.boss_challenges') }}" class="map-btn map-btn-boss">
                <i class="bi bi-skull"></i>
            </a>
        </div>
    </div>
    
    <div class="discipline-tabs">
        {% for discipline, data in campaign.items() %}
        <button class="discipline-tab {% if loop.first %}active{% endif %}" data-discipline="{{ discipline }}">
            {% if discipline == 'Marketing' %}
            <i class="bi bi-megaphone-fill"></i>
            {% elif discipline == 'Finance' %}
            <i class="bi bi-currency-dollar"></i>
            {% elif discipline == 'Operations' %}
            <i class="bi bi-gear-fill"></i>
            {% elif discipline == 'Human Resources' %}
            <i class="bi bi-people-fill"></i>
            {% elif discipline == 'Legal' %}
            <i class="bi bi-briefcase-fill"></i>
            {% elif discipline == 'Strategy' %}
            <i class="bi bi-lightbulb-fill"></i>
            {% endif %}
            <span class="tab-name">{{ discipline.split()[0] }}</span>
            <span class="tab-stars"><i class="bi bi-star-fill"></i>{{ data.total_stars }}</span>
        </button>
        {% endfor %}
    </div>
    
    {% for discipline, data in campaign.items() %}
    <div class="visual-map {% if loop.first %}active{% endif %}" id="map-{{ discipline|replace(' ', '-') }}">
        <div class="map-background">
            <div class="map-overlay"></div>
        </div>
        
        {% set lpath = learning_paths.get(discipline) %}
        {% if lpath and not lpath.path_completed %}
        <div class="learning-gate-banner">
            <div class="gate-header">
                <i class="bi bi-signpost-split"></i> {{ lpath.path_name }}
            </div>
            <div class="gate-steps">
                <div class="gate-step {% if lpath.lesson_completed %}done{% else %}current{% endif %}">
                    <i class="bi {% if lpath.lesson_completed %}bi-check-circle-fill{% else %}bi-book{% endif %}"></i>
                    <span>Lesson</span>
                </div>
                <i class="bi bi-chevron-right gate-arrow"></i>
                <div class="gate-step {% if lpath.trial_completed %}done{% elif lpath.lesson_completed %}current{% else %}locked{% endif %}">
                    <i class="bi {% if lpath.trial_completed %}bi-check-circle-fill{% elif lpath.lesson_completed %}bi-question-circle{% else %}bi-lock{% endif %}"></i>
                    <span>Quiz</span>
                </div>
                <i class="bi bi-chevron-right gate-arrow"></i>
                <div class="gate-step {% if lpath.puzzle_completed %}done{% elif lpath.trial_completed %}current{% else %}locked{% endif %}">
                    <i class="bi {% if lpath.puzzle_completed %}bi-check-circle-fill{% elif lpath.trial_completed %}bi-calculator{% else %}bi-lock{% endif %}"></i>
                    <span>Challenge</span>
                </div>
                <i class="bi bi-chevron-right gate-arrow"></i>
                <div class="gate-step {% if lpath.scenario_completed %}done{% elif lpath.puzzle_completed %}current{% else %}locked{% endif %}">
                    <i class="bi {% if lpath.scenario_completed %}bi-check-circle-fill{% elif lpath.puzzle_completed %}bi-flag{% else %}bi-lock{% endif %}"></i>
                    <span>Scenario</span>
                </div>
            </div>
            <a href="{{ url_for('finance.learning_path_detail', path_id=lpath.path_id) }}" class="gate-btn">
                <i class="bi bi-play-fill"></i> Continue Learning
            </a>
        </div>
        {% endif %}
        
        <div class="map-stats">
            <div class="stat-pill">
                <i class="bi bi-star-fill text-warning"></i>
                {{ data.total_stars }}/{{ data.max_stars }}
            </div>
            <div class="stat-pill">
                <i class="bi bi-check-circle-fill text-success"></i>
                {{ data.completed_count }}/{{ data.total_count }}
            </div>
        </div>
        
        <svg class="path-svg" viewBox="0 0 360 600" preserveAspectRatio="xMidYMid meet">
            <defs>
                <linearGradient id="pathGradient-{{ discipline|replace(' ', '') }}" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#ffd700;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#ff8c00;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="lockedGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#444;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#222;stop-opacity:1" />
                </linearGradient>
                <filter id="glow">
                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
                <filter id="strongGlow">
                    <feGaussianBlur stdDeviation="6" result="coloredBlur"/>
                    <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
            </defs>
            
            {% set positions = [
                {'x': 80, 'y': 550},
                {'x': 180, 'y': 510},
                {'x': 280, 'y': 470},
                {'x': 280, 'y': 390},
                {'x': 180, 'y': 350},
                {'x': 80, 'y': 310},
                {'x': 80, 'y': 230},
                {'x': 180, 'y': 190},
                {'x': 280, 'y': 150},
                {'x': 180, 'y': 80}
            ] %}
            
            {% for i in range(data.nodes|length - 1) %}
            {% set node = data.nodes[i] %}
            {% set next_node = data.nodes[i + 1] %}
            {% set pos = positions[i] %}
            {% set next_pos = positions[i + 1] %}
            <path class="node-path {% if node.completed %}path-complete{% elif node.unlocked %}path-active{% else %}path-locked{% endif %}"
                  d="M {{ pos.x }} {{ pos.y }} Q {{ (pos.x + next_pos.x) / 2 }} {{ (pos.y + next_pos.y) / 2 - 15 }} {{ next_pos.x }} {{ next_pos.y }}"
                  stroke="{% if node.completed %}url(#pathGradient-{{ discipline|replace(' ', '') }}){% elif node.unlocked %}#4a90d9{% else %}#333{% endif %}"
                  stroke-width="8"
                  stroke-linecap="round"
                  fill="none"
                  {% if node.completed %}filter="url(#glow)"{% endif %}/>
            {% endfor %}
            
            {% for node in data.nodes %}
            {% set pos = positions[loop.index0] %}
            <g class="map-node" data-scenario-id="{{ node.scenario_id }}" data-unlocked="{{ node.unlocked|lower }}">
                {% if node.completed %}
                <circle cx="{{ pos.x }}" cy="{{ pos.y }}" r="32" fill="#1a5c34" stroke="#50c878" stroke-width="4" filter="url(#glow)"/>
                <circle cx="{{ pos.x }}" cy="{{ pos.y }}" r="26" fill="url(#pathGradient-{{ discipline|replace(' ', '') }})" opacity="0.3"/>
                <text x="{{ pos.x }}" y="{{ pos.y + 5 }}" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">âœ“</text>
                <g class="node-stars" transform="translate({{ pos.x - 20 }}, {{ pos.y + 38 }})">
                    {% for i in range(3) %}
                    <text x="{{ i * 14 }}" y="0" fill="{% if i < node.stars %}#ffd700{% else %}#555{% endif %}" font-size="12">â˜…</text>
                    {% endfor %}
                </g>
                {% elif node.current %}
                <circle class="pulse-ring" cx="{{ pos.x }}" cy="{{ pos.y }}" r="40" fill="none" stroke="#ffd700" stroke-width="3" opacity="0.5"/>
                <circle cx="{{ pos.x }}" cy="{{ pos.y }}" r="32" fill="#b8860b" stroke="#ffd700" stroke-width="5" filter="url(#strongGlow)"/>
                <text x="{{ pos.x }}" y="{{ pos.y + 7 }}" text-anchor="middle" fill="#fff" font-size="20" font-weight="bold">{{ node.node_index }}</text>
                <text x="{{ pos.x }}" y="{{ pos.y + 55 }}" text-anchor="middle" fill="#ffd700" font-size="11" font-weight="bold">â–¶ PLAY</text>
                {% elif node.unlocked %}
                <circle cx="{{ pos.x }}" cy="{{ pos.y }}" r="30" fill="#1a3a5c" stroke="#4a90d9" stroke-width="4"/>
                <text x="{{ pos.x }}" y="{{ pos.y + 7 }}" text-anchor="middle" fill="#fff" font-size="18" font-weight="bold">{{ node.node_index }}</text>
                {% else %}
                <circle cx="{{ pos.x }}" cy="{{ pos.y }}" r="28" fill="url(#lockedGradient)" stroke="#444" stroke-width="3"/>
                <text x="{{ pos.x }}" y="{{ pos.y + 5 }}" text-anchor="middle" fill="#666" font-size="16">ðŸ”’</text>
                {% endif %}
                
                {% if node.level == 5 %}
                <text x="{{ pos.x + 35 }}" y="{{ pos.y - 20 }}" fill="#ff6b6b" font-size="10" font-weight="bold">ELITE</text>
                {% elif node.level == 10 %}
                <text x="{{ pos.x + 35 }}" y="{{ pos.y - 20 }}" fill="#dc143c" font-size="10" font-weight="bold">BOSS</text>
                {% endif %}
            </g>
            {% endfor %}
            
            <text x="180" y="30" text-anchor="middle" fill="#ffd700" font-size="14" font-weight="bold" opacity="0.8">
                {{ discipline|upper }}
            </text>
        </svg>
    </div>
    {% endfor %}
</div>

<style>
.campaign-container {
    position: relative;
    min-height: 100vh;
    padding: 0;
    margin: -1rem;
    overflow: hidden;
}

.command-hud {
    background: linear-gradient(180deg, rgba(20,20,40,0.98) 0%, rgba(10,10,30,0.95) 100%);
    border-bottom: 3px solid;
    border-image: linear-gradient(90deg, transparent, #ffd700, transparent) 1;
    padding: 12px 15px;
    position: sticky;
    top: 0;
    z-index: 110;
}

.hud-resources {
    display: flex;
    justify-content: space-around;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.resource-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0,0,0,0.4);
    padding: 8px 15px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    min-width: 120px;
}

.resource-item i {
    font-size: 1.5rem;
}

.resource-item.capital i { color: #ffd700; }
.resource-item.morale i { color: #17a2b8; }
.resource-item.brand i { color: #dc3545; }
.resource-item.quarter i { color: #28a745; }

.resource-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.resource-label {
    font-size: 0.7rem;
    color: #aaa;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.resource-value {
    font-family: 'Staatliches', cursive;
    font-size: 1.2rem;
    color: #fff;
}

.resource-bar-wrap {
    width: 80px;
    height: 10px;
    background: rgba(0,0,0,0.5);
    border-radius: 5px;
    overflow: hidden;
}

.resource-bar {
    height: 100%;
    border-radius: 5px;
    transition: width 0.5s ease;
}

.resource-pct {
    font-size: 0.85rem;
    font-weight: bold;
    color: #fff;
}

.quarter-badge {
    background: linear-gradient(135deg, #28a745, #218838);
    padding: 2px 10px;
    border-radius: 4px;
    font-size: 1.1rem;
}

.decision-count {
    font-size: 0.75rem;
    color: #888;
}

.active-buffs {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.1);
    flex-wrap: wrap;
}

.buff-label {
    color: #ffd700;
    font-size: 0.85rem;
    font-weight: bold;
}

.buff-chip {
    background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(184,134,11,0.2));
    border: 1px solid rgba(255,215,0,0.5);
    color: #ffd700;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.buff-chip i {
    font-size: 0.9rem;
}

@media (max-width: 576px) {
    .hud-resources {
        gap: 8px;
    }
    .resource-item {
        padding: 6px 10px;
        min-width: 80px;
    }
    .resource-item i {
        font-size: 1.2rem;
    }
    .resource-bar-wrap {
        width: 50px;
    }
    .resource-value {
        font-size: 1rem;
    }
}

.map-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: rgba(0,0,0,0.8);
    border-bottom: 2px solid rgba(255,215,0,0.4);
    position: sticky;
    top: 0;
    z-index: 100;
}

.map-title {
    font-family: 'Cinzel', serif;
    font-size: 1.3rem;
    color: #ffd700;
    margin: 0;
    text-shadow: 0 0 10px rgba(255,215,0,0.5);
}

.map-nav {
    display: flex;
    gap: 10px;
}

.map-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, #2a2a4a, #1a1a2a);
    border: 2px solid rgba(255,215,0,0.5);
    color: #ffd700;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    text-decoration: none;
    transition: all 0.2s;
}

.map-btn:active {
    transform: scale(0.95);
    background: linear-gradient(135deg, #3a3a5a, #2a2a3a);
}

.map-btn-boss {
    border-color: rgba(220,20,60,0.7);
    color: #dc143c;
}

.discipline-tabs {
    display: flex;
    overflow-x: auto;
    background: rgba(0,0,0,0.9);
    padding: 8px 5px;
    gap: 5px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}

.discipline-tabs::-webkit-scrollbar {
    display: none;
}

.discipline-tab {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 8px 12px;
    background: rgba(40,40,60,0.8);
    border: 2px solid transparent;
    border-radius: 10px;
    color: #888;
    font-size: 0.75rem;
    min-width: 60px;
    cursor: pointer;
    transition: all 0.2s;
}

.discipline-tab i {
    font-size: 1.2rem;
    margin-bottom: 3px;
}

.discipline-tab.active {
    background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(184,134,11,0.2));
    border-color: #ffd700;
    color: #ffd700;
}

.tab-name {
    font-weight: bold;
    white-space: nowrap;
}

.tab-stars {
    font-size: 0.65rem;
    color: #ffd700;
}

.tab-stars i {
    font-size: 0.6rem;
    margin-right: 2px;
}

.visual-map {
    display: none;
    position: relative;
    height: calc(100vh - 140px);
    overflow-y: auto;
    overflow-x: hidden;
}

.visual-map.active {
    display: block;
}

.map-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(ellipse at top, rgba(30,30,60,0.3) 0%, rgba(10,10,30,0.9) 100%),
        linear-gradient(180deg, #0a0a1a 0%, #1a1a3a 50%, #0a0a2a 100%);
    z-index: 0;
}

.map-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        radial-gradient(2px 2px at 20% 30%, rgba(255,255,255,0.15), transparent),
        radial-gradient(2px 2px at 70% 20%, rgba(255,215,0,0.1), transparent),
        radial-gradient(1px 1px at 40% 70%, rgba(255,255,255,0.1), transparent),
        radial-gradient(2px 2px at 80% 60%, rgba(255,255,255,0.08), transparent);
    background-size: 200px 200px;
    animation: twinkle 4s ease-in-out infinite alternate;
}

.map-stats {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 8px;
    z-index: 10;
}

.stat-pill {
    background: rgba(0,0,0,0.7);
    border: 1px solid rgba(255,215,0,0.3);
    border-radius: 15px;
    padding: 5px 10px;
    font-size: 0.75rem;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 4px;
}

.learning-gate-banner {
    position: relative;
    z-index: 20;
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.15), rgba(33, 150, 243, 0.15));
    border: 2px solid rgba(76, 175, 80, 0.4);
    border-radius: 12px;
    padding: 1rem;
    margin: 0.5rem;
    text-align: center;
}
.gate-header {
    color: #81c784;
    font-family: 'Cinzel', serif;
    font-size: 1rem;
    margin-bottom: 0.75rem;
}
.gate-steps {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.35rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
}
.gate-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.35rem 0.5rem;
    border-radius: 6px;
    font-size: 0.7rem;
    background: rgba(255, 255, 255, 0.05);
    color: #666;
}
.gate-step i { font-size: 1rem; }
.gate-step.done { background: rgba(76, 175, 80, 0.2); color: #81c784; }
.gate-step.current { background: rgba(33, 150, 243, 0.2); color: #64b5f6; border: 1px solid rgba(33, 150, 243, 0.5); }
.gate-step.locked { color: #555; }
.gate-arrow { color: #444; font-size: 0.8rem; }
.gate-btn {
    display: inline-block;
    background: linear-gradient(135deg, #4caf50, #388e3c);
    color: white;
    padding: 0.5rem 1.5rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    text-decoration: none;
}
.gate-btn:hover { color: white; transform: scale(1.02); }

.path-svg {
    width: 100%;
    height: 100%;
    position: relative;
    z-index: 5;
}

.map-node {
    cursor: pointer;
    transition: transform 0.2s;
}

.map-node[data-unlocked="true"]:active {
    transform: scale(0.95);
}

.pulse-ring {
    animation: pulseRing 1.5s ease-out infinite;
}

@keyframes pulseRing {
    0% { r: 32; opacity: 0.8; }
    100% { r: 50; opacity: 0; }
}

@keyframes twinkle {
    0% { opacity: 0.5; }
    100% { opacity: 1; }
}

.path-complete {
    stroke-dasharray: none;
}

.path-active {
    stroke-dasharray: 10 5;
    animation: dashMove 1s linear infinite;
}

@keyframes dashMove {
    to { stroke-dashoffset: -15; }
}

.path-locked {
    stroke-dasharray: 5 10;
}

@media (min-width: 500px) {
    .path-svg {
        max-width: 400px;
        margin: 0 auto;
        display: block;
    }
}

@media (max-height: 600px) {
    .visual-map {
        height: calc(100vh - 120px);
    }
    
    .path-svg {
        height: auto;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.discipline-tab');
    const maps = document.querySelectorAll('.visual-map');
    
    function scrollMapToBottom(mapElement) {
        setTimeout(() => {
            if (mapElement) {
                mapElement.scrollTop = mapElement.scrollHeight;
            }
        }, 100);
    }
    
    const activeMap = document.querySelector('.visual-map.active');
    scrollMapToBottom(activeMap);
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            tabs.forEach(t => t.classList.remove('active'));
            maps.forEach(m => m.classList.remove('active'));
            
            this.classList.add('active');
            const discipline = this.dataset.discipline.replace(/ /g, '-');
            const mapElement = document.getElementById('map-' + discipline);
            if (mapElement) {
                mapElement.classList.add('active');
                scrollMapToBottom(mapElement);
            }
        });
    });
    
    document.querySelectorAll('.map-node').forEach(node => {
        const unlocked = node.dataset.unlocked === 'true';
        const scenarioId = node.dataset.scenarioId;
        
        if (unlocked && scenarioId) {
            node.style.cursor = 'pointer';
            node.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = '/play/' + scenarioId;
            });
            node.addEventListener('touchend', function(e) {
                e.preventDefault();
                window.location.href = '/play/' + scenarioId;
            });
        }
    });
});
</script>
{% endblock %}
